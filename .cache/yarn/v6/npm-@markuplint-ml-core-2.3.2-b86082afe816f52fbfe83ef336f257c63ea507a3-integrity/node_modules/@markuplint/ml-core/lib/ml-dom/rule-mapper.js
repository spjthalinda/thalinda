"use strict";
var _RuleMapper_nodeList, _RuleMapper_ruleMap;
Object.defineProperty(exports, "__esModule", { value: true });
exports.RuleMapper = void 0;
const tslib_1 = require("tslib");
const debug_1 = require("../debug");
const selector_1 = require("./helper/selector");
const ruleMapperLog = debug_1.log.extend('rule-mapper');
const ruleMapperNodeLog = ruleMapperLog.extend('node');
const ruleMapperNodeRuleLog = ruleMapperNodeLog.extend('rule');
class RuleMapper {
    constructor(nodeList) {
        _RuleMapper_nodeList.set(this, void 0);
        _RuleMapper_ruleMap.set(this, new Map());
        tslib_1.__classPrivateFieldSet(this, _RuleMapper_nodeList, nodeList, "f");
    }
    set(node, ruleName, rule) {
        if (node.type === 'ElementCloseTag') {
            return;
        }
        const rules = tslib_1.__classPrivateFieldGet(this, _RuleMapper_ruleMap, "f").get(node.uuid) || {};
        const currentRule = rules[ruleName];
        if (currentRule) {
            const order = (0, selector_1.compareSpecificity)(currentRule.specificity, rule.specificity);
            if (order === 1) {
                ruleMapperLog("Don't set %o ([%s] vs [%s])", rule, currentRule.specificity, rule.specificity);
                return;
            }
            ruleMapperLog('Unset %o from %s', currentRule, node);
        }
        rules[ruleName] = rule;
        tslib_1.__classPrivateFieldGet(this, _RuleMapper_ruleMap, "f").set(node.uuid, rules);
        if (node.type === 'Element' && node.closeTag) {
            tslib_1.__classPrivateFieldGet(this, _RuleMapper_ruleMap, "f").set(node.closeTag.uuid, rules);
        }
        ruleMapperLog('Set to %s from %s (%o): %O', node.raw, rule.from, rule.specificity, rule.rule);
    }
    apply() {
        ruleMapperLog('ruleTree:');
        tslib_1.__classPrivateFieldGet(this, _RuleMapper_nodeList, "f").forEach(node => {
            const rules = tslib_1.__classPrivateFieldGet(this, _RuleMapper_ruleMap, "f").get(node.uuid);
            if (!rules) {
                return;
            }
            const slash = node.type === 'ElementCloseTag' ? '/' : '';
            const nodeName = 'nodeName' in node ? node.nodeName : `#${node.type}`;
            ruleMapperNodeLog('<%s%s>', slash, nodeName);
            Object.keys(rules).forEach(ruleName => {
                const rule = rules[ruleName];
                node.rules[ruleName] = rule.rule;
                ruleMapperNodeRuleLog('[from: %s(%s)] %s: %o', rule.from, rule.specificity, ruleName, rule.rule);
            });
        });
    }
}
exports.RuleMapper = RuleMapper;
_RuleMapper_nodeList = new WeakMap(), _RuleMapper_ruleMap = new WeakMap();
