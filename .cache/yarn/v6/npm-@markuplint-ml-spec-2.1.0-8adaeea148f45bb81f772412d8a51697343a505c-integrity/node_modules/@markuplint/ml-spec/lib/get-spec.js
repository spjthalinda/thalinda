"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSpec = void 0;
const utils_1 = require("./utils");
/**
 * Merging HTML-spec schema and extended spec schemas
 *
 * Ex: `@markuplint/html-spec` + `{ specs: ["@markuplint/vue-spec"] }` in cofigure files.
 *
 * @param schemas `MLDocument.schemas`
 */
function getSpec(schemas) {
    var _a, _b, _c;
    const [main, ...extendedSpecs] = schemas;
    const result = { ...main };
    for (const extendedSpec of extendedSpecs) {
        if (extendedSpec.cites) {
            result.cites = [...result.cites, ...extendedSpec.cites];
        }
        if (extendedSpec.def) {
            if (extendedSpec.def['#ariaAttrs']) {
                result.def['#ariaAttrs'] = [...result.def['#ariaAttrs'], ...extendedSpec.def['#ariaAttrs']];
            }
            if ((_a = extendedSpec.def['#globalAttrs']) === null || _a === void 0 ? void 0 : _a['#extends']) {
                result.def['#globalAttrs']['#HTMLGlobalAttrs'] = {
                    ...(((_b = result.def['#globalAttrs']) === null || _b === void 0 ? void 0 : _b['#HTMLGlobalAttrs']) || {}),
                    ...(((_c = extendedSpec.def['#globalAttrs']) === null || _c === void 0 ? void 0 : _c['#extends']) || {}),
                };
            }
            if (extendedSpec.def['#roles']) {
                result.def['#roles'] = [...result.def['#roles'], ...extendedSpec.def['#roles']];
            }
            if (extendedSpec.def['#contentModels']) {
                const keys = new Set([
                    ...Object.keys(result.def['#contentModels']),
                    ...Object.keys(extendedSpec.def['#contentModels']),
                ]);
                for (const modelName of keys) {
                    const mainModel = result.def['#contentModels'][modelName];
                    const exModel = extendedSpec.def['#contentModels'][modelName];
                    result.def['#contentModels'][modelName] = [...(mainModel || []), ...(exModel || [])];
                }
            }
        }
        if (extendedSpec.specs) {
            const exSpecs = extendedSpec.specs.slice();
            const specs = [];
            for (const elSpec of result.specs) {
                const tagName = elSpec.name.toLowerCase();
                const index = exSpecs.findIndex(spec => spec.name.toLowerCase() === tagName);
                if (index === -1) {
                    specs.push(elSpec);
                    continue;
                }
                const exSpec = exSpecs.splice(index, 1)[0];
                specs.push({
                    ...elSpec,
                    ...exSpec,
                    globalAttrs: {
                        ...elSpec.globalAttrs,
                        ...exSpec.globalAttrs,
                    },
                    attributes: mergeAttrSpec(elSpec.attributes, exSpec.attributes),
                    categories: (0, utils_1.mergeArray)(elSpec.categories, exSpec.categories),
                });
            }
            result.specs = specs;
        }
    }
    return result;
}
exports.getSpec = getSpec;
function mergeAttrSpec(std, ex = {}) {
    const result = {};
    const keys = Array.from(new Set([...Object.keys(std), ...Object.keys(ex)]));
    for (const key of keys) {
        const _std = std[key];
        const _ex = ex[key];
        result[key] = {
            ..._std,
            ..._ex,
        };
    }
    return result;
}
